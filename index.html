<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Urplace</title>

    <style>
        /* TEMEL SAYFA D√úZENƒ∞ */
        html, body {
            height: 100%; margin: 0; overflow: hidden; 
            background-color: #DADDE1; font-family: Arial, sans-serif;
            display: flex; flex-direction: column;
            user-select: none;
        }
        .main-content {
            flex-grow: 1; display: grid; place-items: center; overflow: auto;
        }
        .content-inner { text-align: center; }
        .canvas-wrapper {
            position: relative; width: 1920px; height: 1080px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); flex-shrink: 0;
        }
        .canvas-wrapper canvas {
            position: absolute; top: 0; left: 0; border: 2px solid #333;
        }
        #main-canvas { background-color: #f0f0f0; z-index: 0; }
        #hover-canvas { background-color: transparent; cursor: crosshair; z-index: 1; }
        
        /* Bƒ∞LGƒ∞ PANELLERƒ∞ */
        .info-panel {
            position: fixed; background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1002; font-size: 1em; font-weight: bold;
        }
        
        #online-users-container {
            top: 15px; right: 15px;
            cursor: pointer; /* Tƒ±klanabilir olduƒüunu belirtir */
            transition: background-color 0.2s;
        }
        #online-users-container:hover {
             background-color: #f0f0f0;
        }
        #online-users-container span { color: #28a745; }
        
        #leaderboard-container { top: 15px; left: 15px; width: 220px; }
        #leaderboard-container h3 { margin: 0 0 10px 0; text-align: center; font-size: 1.1em; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        #leaderboard-list { list-style-type: none; padding: 0; margin: 0; }
        #leaderboard-list li { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.9em; }
        #leaderboard-list li .rank { font-weight: bold; margin-right: 10px; }
        #leaderboard-list li .username { flex-grow: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        #leaderboard-list li .score { font-weight: bold; color: #007bff; }

        /* KONTROL PANELƒ∞, MODAL, TOOLTIP */
        .controls{padding:8px;background-color:#fff;border-top:1px solid #ccc;display:flex;justify-content:space-around;align-items:center;flex-shrink:0;z-index:10;box-sizing:border-box}
        .user-info,.timer-info{font-size:1em;margin:0 5px}#color-picker-container{display:flex;align-items:center;gap:8px}#color-picker{width:40px;height:30px;border:1px solid #ccc;border-radius:5px;cursor:pointer;padding:0}
        #color-picker-label{font-weight:bold}#tooltip{position:fixed;display:none;background-color:rgba(0,0,0,.8);color:#fff;padding:8px 12px;border-radius:5px;font-size:.9em;pointer-events:none;z-index:1001;white-space:nowrap}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000}
        .modal-content{background-color:#fff;padding:30px;border-radius:10px;text-align:center}#username-input,#save-username-btn{font-size:1em;padding:10px;border-radius:5px}

        /* MOBƒ∞L UYUM */
        @media (max-width: 768px) {
            #leaderboard-container { width: 150px; padding: 8px; top: 10px; left: 10px; }
            #leaderboard-container h3 { font-size: 1em; margin-bottom: 5px;}
            #leaderboard-list li { font-size: 0.8em; }
            #online-users-container { top: 10px; right: 10px; padding: 8px 12px; }
            .controls { flex-wrap: wrap; justify-content: center; padding: 5px;}
            .timer-info { margin-top: 5px; }
            h1 { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    
    <div id="username-modal" class="modal-overlay">
        <!-- Modal ƒ∞√ßeriƒüi -->
    </div>

    <div id="online-users-container" class="info-panel">
        Online Kullanƒ±cƒ±lar: <span id="online-users-count">0</span>
    </div>
    
    <div id="leaderboard-container" class="info-panel">
        <h3>üèÜ En ƒ∞yiler</h3>
        <ol id="leaderboard-list"></ol>
    </div>

    <main class="main-content">
        <div class="content-inner">
            <h1>Urplace</h1>
            <div class="canvas-wrapper">
                <canvas id="main-canvas" width="1920" height="1080"></canvas>
                <canvas id="hover-canvas" width="1920" height="1080"></canvas>
            </div>
        </div>
    </main>
    
    <div id="tooltip"></div>
    <div class="controls">
        <!-- Kontrol Paneli ƒ∞√ßeriƒüi -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // --- SUPABASE AYARLARI ---
        const SUPABASE_URL = 'https://mruogrrmbhehharznuru.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ydW9ncnJtYmhlaGhhcnpudXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MzcwNDUsImV4cCI6MjA3MTQxMzA0NX0.q6s8w-xty1NWiPEDJrnsVV-7I-SNrz0qdENsuPjLhBk';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL DEƒûƒ∞≈ûKENLER ---
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const onlineUsersContainer = document.getElementById('online-users-container');
        const leaderboardList = document.getElementById('leaderboard-list');
        const onlineUsersCount = document.getElementById('online-users-count');
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const hoverCanvas = document.getElementById('hover-canvas');
        const hoverCtx = hoverCanvas.getContext('2d');
        const colorPicker = document.getElementById('color-picker');
        const tooltip = document.getElementById('tooltip');
        const timerDisplay = document.getElementById('timer-display');
        const usernameDisplay = document.getElementById('username-display');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        
        const PIXEL_SIZE = 10;
        const GRID_WIDTH = canvas.width / PIXEL_SIZE;
        const GRID_HEIGHT = canvas.height / PIXEL_SIZE;
        let selectedColor = colorPicker.value;
        let username = '';
        const COOLDOWN_SECONDS = 2.3;
        
        const pixelDataMap = new Map();
        let channel;
        let isLeaderboardVisible = true; // YENƒ∞: Liderlik tablosunun durumunu tutar

        function getUniqueUserId(){let e=localStorage.getItem("unique_user_id");return e||(e=Date.now().toString(36)+Math.random().toString(36).substring(2),localStorage.setItem("unique_user_id",e)),e}
        const uniqueUserId = getUniqueUserId();
        
        function setupColorPicker(){colorPicker.addEventListener("input",e=>{selectedColor=e.target.value})}

        // YENƒ∞: Panel a√ß/kapa mantƒ±ƒüƒ±
        function setupPanelToggle() {
            // Sayfa y√ºklendiƒüinde √∂nceki durumu kontrol et
            const savedState = sessionStorage.getItem('leaderboardVisible');
            if (savedState === 'false') {
                leaderboardContainer.style.display = 'none';
                isLeaderboardVisible = false;
            }

            // Online kullanƒ±cƒ±lar paneline tƒ±klama olayƒ± ekle
            onlineUsersContainer.addEventListener('click', () => {
                isLeaderboardVisible = !isLeaderboardVisible; // Durumu tersine √ßevir
                leaderboardContainer.style.display = isLeaderboardVisible ? 'block' : 'none';
                sessionStorage.setItem('leaderboardVisible', isLeaderboardVisible); // Yeni durumu kaydet
            });
        }

        function handleUsername(){const e=localStorage.getItem("global_canvas_username");e?(username=e,usernameDisplay.textContent=username,usernameModal.style.display="none",init()):usernameModal.style.display="flex"}
        saveUsernameBtn.addEventListener("click",()=>{const e=usernameInput.value.trim();e&&(username=e,localStorage.setItem("global_canvas_username",username),usernameDisplay.textContent=username,usernameModal.style.display="none",init())});
        
        function drawGridCell(e,t,o){ctx.fillStyle=o,ctx.fillRect(e*PIXEL_SIZE,t*PIXEL_SIZE,PIXEL_SIZE,PIXEL_SIZE)}
        
        function drawInitialGrid(){ctx.clearRect(0,0,canvas.width,canvas.height);for(let e=0;e<GRID_WIDTH;e++)for(let t=0;t<GRID_HEIGHT;t++)ctx.fillStyle="#FFFFFF",ctx.fillRect(e*PIXEL_SIZE,t*PIXEL_SIZE,PIXEL_SIZE,PIXEL_SIZE),ctx.strokeStyle="#E0E0E0",ctx.strokeRect(e*PIXEL_SIZE,t*PIXEL_SIZE,PIXEL_SIZE,PIXEL_SIZE)}
        
        async function fetchInitialCanvas(){console.log("Mevcut pikseller √ßekiliyor..."),pixelDataMap.clear();const{data:e,error:t}=await supabaseClient.from("pixels").select("*");t?console.error("Pikselleri √ßekerken hata:",t):e.forEach(e=>{drawGridCell(e.x,e.y,e.color);const t=`${e.x},${e.y}`;pixelDataMap.set(t,{username:e.username,color:e.color})}),console.log(`${e.length} piksel y√ºklendi.`)}
        
        let cooldownInterval;
        function startCooldownTimer(){let e=COOLDOWN_SECONDS;localStorage.setItem("last_pixel_time",Date.now()),timerDisplay.textContent=`${e.toFixed(1)}s`,hoverCanvas.style.cursor="not-allowed",cooldownInterval=setInterval(()=>{e-=.1,e<=0?(clearInterval(cooldownInterval),timerDisplay.textContent="Hazƒ±r!",hoverCanvas.style.cursor="crosshair"):timerDisplay.textContent=`${e.toFixed(1)}s`},100)}
        function checkCooldown(){const e=localStorage.getItem("last_pixel_time");if(!e)return!0;const t=(Date.now()-parseInt(e))/1e3;if(t>=COOLDOWN_SECONDS)return!0;{const o=COOLDOWN_SECONDS-t;return startCooldownTimerFrom(o),!1}}
        function startCooldownTimerFrom(e){clearInterval(cooldownInterval);let t=e;timerDisplay.textContent=`${t.toFixed(1)}s`,hoverCanvas.style.cursor="not-allowed",cooldownInterval=setInterval(()=>{t-=.1,t<=0?(clearInterval(cooldownInterval),timerDisplay.textContent="Hazƒ±r!",hoverCanvas.style.cursor="crosshair"):timerDisplay.textContent=`${t.toFixed(1)}s`},100)}
        
        hoverCanvas.addEventListener("mousemove",e=>{const t=hoverCanvas.getBoundingClientRect(),o=e.clientX-t.left,n=e.clientY-t.top,s=Math.floor(o/PIXEL_SIZE),i=Math.floor(n/PIXEL_SIZE);if(hoverCtx.clearRect(0,0,hoverCanvas.width,hoverCanvas.height),tooltip.style.display="none",s>=0&&s<GRID_WIDTH&&i>=0&&i<GRID_HEIGHT){hoverCtx.fillStyle=selectedColor,hoverCtx.fillRect(s*PIXEL_SIZE,i*PIXEL_SIZE,PIXEL_SIZE,PIXEL_SIZE);const l=`${s},${i}`;pixelDataMap.has(l)&&(tooltip.innerHTML=`(${s}, ${i})<br>Yapan: ${pixelDataMap.get(l).username}<br>Renk: ${pixelDataMap.get(l).color}`,tooltip.style.left=`${e.clientX+15}px`,tooltip.style.top=`${e.clientY+15}px`,tooltip.style.display="block")}});
        hoverCanvas.addEventListener("mouseout",()=>{hoverCtx.clearRect(0,0,hoverCanvas.width,hoverCanvas.height),tooltip.style.display="none"});
        
        hoverCanvas.addEventListener("click",async e=>{
            if(!username)return void alert("L√ºtfen √∂nce bir kullanƒ±cƒ± adƒ± belirleyin.");
            if(!checkCooldown())return void alert("L√ºtfen bir sonraki piksel i√ßin bekleyin.");
            const t=hoverCanvas.getBoundingClientRect(),o=e.clientX-t.left,n=e.clientY-t.top,s=Math.floor(o/PIXEL_SIZE),i=Math.floor(n/PIXEL_SIZE);
            if(s<0||s>=GRID_WIDTH||i<0||i>=GRID_HEIGHT) return;
            
            const originalColor=pixelDataMap.get(`${s},${i}`)?.color||"#FFFFFF";
            drawGridCell(s,i,"#CCCCCC");
            
            const{error:r}=await supabaseClient.from("pixels").upsert({x:s,y:i,color:selectedColor,username:username},{onConflict:"x,y"});
            r?(console.error("Piksel g√∂nderilemedi:",r),drawGridCell(s,i,"#FF0000"),setTimeout(()=>{drawGridCell(s,i,originalColor)},500)):startCooldownTimer()
        });

        async function updateLeaderboard(){const{data:e,error:t}=await supabaseClient.rpc("get_leaderboard");if(t)return void console.error("Liderlik tablosu alƒ±namadƒ±:",t);leaderboardList.innerHTML="",e&&e.forEach((e,t)=>{const o=document.createElement("li");o.innerHTML=`<span class="rank">${t+1}.</span><span class="username" title="${e.username}">${e.username}</span><span class="score">${e.pixel_count}</span>`,leaderboardList.appendChild(o)})}
        function updateOnlineUsersDisplay(e){const t=Object.keys(e).length;onlineUsersCount.textContent=t}
        
        function subscribeToChanges(){
            if(channel) supabaseClient.removeChannel(channel);
            
            channel=supabaseClient.channel("pixels_changes",{config:{presence:{key:uniqueUserId}}});
            channel.on("postgres_changes",{event:"*",schema:"public",table:"pixels"},e=>{const{x:t,y:o,color:n,username:s}=e.new;drawGridCell(t,o,n);const i=`${t},${o}`;pixelDataMap.set(i,{username:s,color:n})});
            
            channel.on("presence",{event:"sync"},()=>{updateOnlineUsersDisplay(channel.presenceState())});
            channel.on("presence",{event:"join"},()=>{updateOnlineUsersDisplay(channel.presenceState())});
            channel.on("presence",{event:"leave"},()=>{updateOnlineUsersDisplay(channel.presenceState())});
            
            channel.subscribe(async e=>{if("SUBSCRIBED"===e)await channel.track({username:username,online_at:(new Date).toISOString()}),console.log(`Kanala ${username} olarak (ID: ${uniqueUserId}) abone olundu.`)});
        }
        
        function init(){
            setupColorPicker();
            setupPanelToggle(); // setupClosablePanels yerine bu geldi
            drawInitialGrid();
            fetchInitialCanvas();
            subscribeToChanges();
            checkCooldown();
            updateLeaderboard(); 
            setInterval(updateLeaderboard,30000);
        }
        
        document.querySelector("#username-modal .modal-content").innerHTML=`<h2>Ho≈ü Geldin!</h2><p>L√ºtfen tuvali kullanmak i√ßin bir isim gir.</p><input type="text" id="username-input" placeholder="ƒ∞sminiz..." maxlength="15"><button id="save-username-btn">Kaydet ve Ba≈üla</button>`;
        document.querySelector(".controls").innerHTML=`<div class="user-info">Kullanƒ±cƒ±: <strong id="username-display">...</strong></div><div id="color-picker-container"><label for="color-picker" id="color-picker-label">Renk Se√ß:</label><input type="color" id="color-picker" value="#FF0000"></div><div class="timer-info">Kalan S√ºre: <strong id="timer-display">Hazƒ±r!</strong></div>`;

        handleUsername();
    </script>
</body>
</html>
