<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Uplace</title>

    <style>
        /* TEMEL SAYFA D√úZENƒ∞ */
        html, body {
            height: 100%; margin: 0; overflow: hidden; 
            background-color: #DADDE1; font-family: Arial, sans-serif;
            display: flex; flex-direction: column;
            user-select: none;
        }
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; 
            padding: 20px; box-sizing: border-box; overflow: auto;
        }
        .canvas-wrapper {
            position: relative; width: 1920px; height: 1080px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); flex-shrink: 0;
        }
        .canvas-wrapper canvas {
            position: absolute; top: 0; left: 0; border: 2px solid #333;
        }
        #main-canvas { background-color: #FFFFFF; z-index: 0; }
        #hover-canvas { background-color: transparent; cursor: crosshair; z-index: 1; }
        
        /* Bƒ∞LGƒ∞ PANELLERƒ∞ */
        .info-panel {
            position: fixed; background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1002; font-size: 1em; font-weight: bold;
        }
        .info-panel .close-btn {
            position: absolute; top: 2px; right: 5px; cursor: pointer;
            font-size: 1.2em; color: #aaa;
        }
        .info-panel .close-btn:hover { color: #333; }
        #online-users-container { top: 15px; right: 15px; }
        #online-users-container span { color: #28a745; }
        #leaderboard-container { top: 15px; left: 15px; width: 220px; }
        #leaderboard-container h3 { margin: 0 0 10px 0; text-align: center; font-size: 1.1em; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        #leaderboard-list { list-style-type: none; padding: 0; margin: 0; }
        #leaderboard-list li { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.9em; }
        #leaderboard-list li .rank { font-weight: bold; margin-right: 10px; }
        #leaderboard-list li .username { flex-grow: 1; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        #leaderboard-list li .score { font-weight: bold; color: #007bff; }

        /* KONTROL PANELƒ∞, MODAL, TOOLTIP */
        .controls{padding:8px;background-color:#fff;border-top:1px solid #ccc;display:flex;justify-content:space-around;align-items:center;flex-shrink:0;z-index:10;box-sizing:border-box}
        .user-info,.timer-info{font-size:1em;margin:0 5px}#color-picker-container{display:flex;align-items:center;gap:8px}#color-picker{width:40px;height:30px;border:1px solid #ccc;border-radius:5px;cursor:pointer;padding:0}
        #color-picker-label{font-weight:bold}#tooltip{position:fixed;display:none;background-color:rgba(0,0,0,.8);color:#fff;padding:8px 12px;border-radius:5px;font-size:.9em;pointer-events:none;z-index:1001;white-space:nowrap}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000}
        .modal-content{background-color:#fff;padding:30px;border-radius:10px;text-align:center}#username-input,#save-username-btn{font-size:1em;padding:10px;border-radius:5px}

        /* MOBƒ∞L UYUM */
        @media (max-width: 768px) {
            #leaderboard-container { width: 150px; padding: 8px; top: 10px; left: 10px; }
            #leaderboard-container h3 { font-size: 1em; margin-bottom: 5px;}
            #leaderboard-list li { font-size: 0.8em; }
            #online-users-container { top: 10px; right: 10px; padding: 8px 12px; }
            .controls { flex-wrap: wrap; justify-content: center; padding: 5px;}
            .timer-info { margin-top: 5px; }
            h1 { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    
    <div id="username-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Ho≈ü Geldin!</h2>
            <p>L√ºtfen tuvali kullanmak i√ßin bir isim gir.</p>
            <input type="text" id="username-input" placeholder="ƒ∞sminiz..." maxlength="15">
            <button id="save-username-btn">Kaydet ve Ba≈üla</button>
        </div>
    </div>

    <div id="online-users-container" class="info-panel">
        <span class="close-btn" data-panel="online-users">&times;</span>
        Online Kullanƒ±cƒ±lar: <span id="online-users-count">0</span>
    </div>
    
    <div id="leaderboard-container" class="info-panel">
        <span class="close-btn" data-panel="leaderboard">&times;</span>
        <h3>üèÜ En ƒ∞yiler</h3>
        <ol id="leaderboard-list"></ol>
    </div>

    <main class="main-content">
        <h1>urplace</h1>
        <div class="canvas-wrapper">
            <canvas id="main-canvas" width="1920" height="1080"></canvas>
            <canvas id="hover-canvas" width="1920" height="1080"></canvas>
        </div>
    </main>
    
    <div id="tooltip"></div>
    <div class="controls">
        <div class="user-info">Kullanƒ±cƒ±: <strong id="username-display">...</strong></div>
        <div id="color-picker-container">
            <label for="color-picker" id="color-picker-label">Renk Se√ß:</label>
            <input type="color" id="color-picker" value="#FF0000">
        </div>
        <div class="timer-info">Kalan S√ºre: <strong id="timer-display">Hazƒ±r!</strong></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // --- SUPABASE AYARLARI ---
        const SUPABASE_URL = 'https://mruogrrmbhehharznuru.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ydW9ncnJtYmhlaGhhcnpudXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MzcwNDUsImV4cCI6MjA3MTQxMzA0NX0.q6s8w-xty1NWiPEDJrnsVV-7I-SNrz0qdENsuPjLhBk';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL DEƒûƒ∞≈ûKENLER ---
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const onlineUsersContainer = document.getElementById('online-users-container');
        const leaderboardList = document.getElementById('leaderboard-list');
        const onlineUsersCount = document.getElementById('online-users-count');
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const hoverCanvas = document.getElementById('hover-canvas');
        const hoverCtx = hoverCanvas.getContext('2d');
        const colorPicker = document.getElementById('color-picker');
        const tooltip = document.getElementById('tooltip');
        const timerDisplay = document.getElementById('timer-display');
        const usernameDisplay = document.getElementById('username-display');
        const usernameModal = document.getElementById('username-modal');
        const usernameInput = document.getElementById('username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        
        let selectedColor = colorPicker.value;
        let username = '';
        const COOLDOWN_SECONDS = 5; // G√ºvenli olmasƒ± i√ßin 5 saniyede tutuyoruz
        
        const pixelDataMap = new Map();
        let channel;

        function getUniqueUserId(){let e=localStorage.getItem("unique_user_id");return e||(e=Date.now().toString(36)+Math.random().toString(36).substring(2),localStorage.setItem("unique_user_id",e)),e}
        const uniqueUserId = getUniqueUserId();

        function setupColorPicker(){colorPicker.addEventListener("input",e=>{selectedColor=e.target.value})}
        
        function setupClosablePanels(){document.querySelectorAll(".close-btn").forEach(e=>{e.addEventListener("click",t=>{const o=t.target.dataset.panel,n=document.getElementById(`${o}-container`);n&&(n.style.display="none",sessionStorage.setItem(`${o}Closed`,"true"))})}),"true"===sessionStorage.getItem("leaderboardClosed")&&(leaderboardContainer.style.display="none"),"true"===sessionStorage.getItem("online-usersClosed")&&(onlineUsersContainer.style.display="none")}
        
        function handleUsername(){const e=localStorage.getItem("global_canvas_username");e?(username=e,usernameDisplay.textContent=username,usernameModal.style.display="none",init()):usernameModal.style.display="flex"}
        saveUsernameBtn.addEventListener("click",()=>{const e=usernameInput.value.trim();e&&(username=e,localStorage.setItem("global_canvas_username",username),usernameDisplay.textContent=username,usernameModal.style.display="none",init())});
        
        function drawPixel(e,t,o){ctx.fillStyle=o,ctx.fillRect(e,t,1,1)}
        
        async function fetchInitialCanvas(){console.log("Mevcut pikseller √ßekiliyor..."),pixelDataMap.clear(),ctx.clearRect(0,0,canvas.width,canvas.height);const{data:e,error:t}=await supabaseClient.from("pixels").select("*");t?console.error("Pikselleri √ßekerken hata:",t):e.forEach(e=>{drawPixel(e.x,e.y,e.color);const t=`${e.x},${e.y}`;pixelDataMap.set(t,{username:e.username,color:e.color})}),console.log(`${e.length} piksel y√ºklendi.`)}
        
        let cooldownInterval;
        function startCooldownTimer(){let e=COOLDOWN_SECONDS;localStorage.setItem("last_pixel_time",Date.now()),timerDisplay.textContent=`${e.toFixed(1)}s`,hoverCanvas.style.cursor="not-allowed",cooldownInterval=setInterval(()=>{e-=.1,e<=0?(clearInterval(cooldownInterval),timerDisplay.textContent="Hazƒ±r!",hoverCanvas.style.cursor="crosshair"):timerDisplay.textContent=`${e.toFixed(1)}s`},100)}
        function checkCooldown(){const e=localStorage.getItem("last_pixel_time");if(!e)return!0;const t=(Date.now()-parseInt(e))/1e3;if(t>=COOLDOWN_SECONDS)return!0;{const o=COOLDOWN_SECONDS-t;return startCooldownTimerFrom(o),!1}}
        function startCooldownTimerFrom(e){clearInterval(cooldownInterval);let t=e;timerDisplay.textContent=`${t.toFixed(1)}s`,hoverCanvas.style.cursor="not-allowed",cooldownInterval=setInterval(()=>{t-=.1,t<=0?(clearInterval(cooldownInterval),timerDisplay.textContent="Hazƒ±r!",hoverCanvas.style.cursor="crosshair"):timerDisplay.textContent=`${t.toFixed(1)}s`},100)}
        
        hoverCanvas.addEventListener("mousemove",e=>{const t=hoverCanvas.getBoundingClientRect(),o=Math.floor(e.clientX-t.left),n=Math.floor(e.clientY-t.top);hoverCtx.clearRect(0,0,hoverCanvas.width,hoverCanvas.height),tooltip.style.display="none",hoverCtx.fillStyle=selectedColor,hoverCtx.fillRect(o,n,1,1);const s=`${o},${n}`;pixelDataMap.has(s)&&(tooltip.innerHTML=`(${o}, ${n})<br>Yapan: ${pixelDataMap.get(s).username}<br>Renk: ${pixelDataMap.get(s).color}`,tooltip.style.left=`${e.clientX+15}px`,tooltip.style.top=`${e.clientY+15}px`,tooltip.style.display="block")});
        hoverCanvas.addEventListener("mouseout",()=>{hoverCtx.clearRect(0,0,hoverCanvas.width,hoverCanvas.height),tooltip.style.display="none"});
        
        hoverCanvas.addEventListener("click",async e=>{
            if(!username)return void alert("L√ºtfen √∂nce bir kullanƒ±cƒ± adƒ± belirleyin.");
            if(!checkCooldown())return void alert("L√ºtfen bir sonraki piksel i√ßin bekleyin.");
            
            const rect = hoverCanvas.getBoundingClientRect(),
                  x = Math.floor(e.clientX - rect.left),
                  y = Math.floor(e.clientY - rect.top);

            const originalColor = pixelDataMap.get(`${x},${y}`)?.color || '#FFFFFF';
            drawPixel(x, y, '#CCCCCC');

            const { error } = await supabaseClient
                .from("pixels")
                .upsert({ x: x, y: y, color: selectedColor, username: username }, { onConflict: "x,y" });

            if(error){
                console.error("Piksel g√∂nderilemedi:", error);
                drawPixel(x, y, '#FF0000');
                setTimeout(() => { drawPixel(x, y, originalColor); }, 500);
            } else {
                startCooldownTimer();
            }
        });

        async function updateLeaderboard(){const{data:e,error:t}=await supabaseClient.rpc("get_leaderboard");if(t)return void console.error("Liderlik tablosu alƒ±namadƒ±:",t);leaderboardList.innerHTML="",e&&e.forEach((e,t)=>{const o=document.createElement("li");o.innerHTML=`<span class="rank">${t+1}.</span><span class="username" title="${e.username}">${e.username}</span><span class="score">${e.pixel_count}</span>`,leaderboardList.appendChild(o)})}
        function updateOnlineUsersDisplay(e){const t=Object.keys(e).length;onlineUsersCount.textContent=t}
        
        function subscribeToChanges(){
            if(channel) supabaseClient.removeChannel(channel);
            
            channel = supabaseClient.channel("pixels_changes", { config: { presence: { key: uniqueUserId } } });

            channel.on("postgres_changes", { event: "*", schema: "public", table: "pixels" }, e=>{
                const { x: t, y: o, color: n, username: s } = e.new;
                drawPixel(t, o, n);
                const i = `${t},${o}`;
                pixelDataMap.set(i, { username: s, color: n });
            });

            channel.on("presence", { event: "sync" }, () => { updateOnlineUsersDisplay(channel.presenceState()); });
            channel.on("presence", { event: "join" }, () => { updateOnlineUsersDisplay(channel.presenceState()); });
            channel.on("presence", { event: "leave" }, () => { updateOnlineUsersDisplay(channel.presenceState()); });

            channel.subscribe(async e => {
                if("SUBSCRIBED" === e) {
                    await channel.track({ username: username, online_at: (new Date).toISOString() });
                    console.log(`Kanala ${username} olarak (ID: ${uniqueUserId}) abone olundu.`);
                }
            });
        }

        function init(){
            setupColorPicker();
            setupClosablePanels();
            fetchInitialCanvas();
            subscribeToChanges();
            checkCooldown();
            updateLeaderboard(); 
            setInterval(updateLeaderboard, 30000);
        }
        
        document.querySelector("#username-modal .modal-content").innerHTML=`<h2>Ho≈ü Geldin!</h2><p>L√ºtfen tuvali kullanmak i√ßin bir isim gir.</p><input type="text" id="username-input" placeholder="ƒ∞sminiz..." maxlength="15"><button id="save-username-btn">Kaydet ve Ba≈üla</button>`;
        document.querySelector(".controls").innerHTML=`<div class="user-info">Kullanƒ±cƒ±: <strong id="username-display">...</strong></div><div id="color-picker-container"><label for="color-picker" id="color-picker-label">Renk Se√ß:</label><input type="color" id="color-picker" value="#FF0000"></div><div class="timer-info">Kalan S√ºre: <strong id="timer-display">Hazƒ±r!</strong></div>`;
        
        handleUsername();
    </script>
</body>
</html>
